name: Build TIC-80 Pro

on: 
  push:
  pull_request:
  workflow_dispatch: # 支持手动触发

jobs:
  # === Windows Build (Pro) ===
  windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - name: Build Pro Version
        shell: cmd
        run: |
          mkdir build_pro
          cd build_pro
          :: 重点：BUILD_PRO=ON 和 BUILD_WITH_ALL=ON 开启全功能 Pro
          cmake -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release -DBUILD_PRO=ON -DBUILD_IPO=ON -DBUILD_WITH_ALL=ON ..
          cmake --build . --config Release --parallel

      - name: Upload Windows Pro
        uses: actions/upload-artifact@v4
        with:
          name: tic80-pro-windows
          path: |
            build_pro/bin/tic80.exe
            build_pro/bin/*.dll

  # === Linux Build (AppImage) ===
  linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install libxi-dev libxcursor-dev libasound2-dev libgl-dev libfuse2 -y

      - name: Build Pro AppImage
        run: |
          mkdir build_linux
          cd build_linux
          cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_PRO=ON -DBUILD_WITH_ALL=ON ..
          cmake --build . --parallel
          cd ..
          chmod +x build-appimage.sh
          ./build-appimage.sh

      - name: Upload Linux Pro
        uses: actions/upload-artifact@v4
        with:
          name: tic80-pro-linux
          path: TIC-80.AppImage

  # === Web (Wasm) Build ===
  webapp:
    runs-on: ubuntu-latest
    steps:
      - uses: mymindstorm/setup-emsdk@v14

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - name: Build Web Version
        run: |
          mkdir build_web
          cd build_web
          emcmake cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_WITH_ALL=ON ..
          cmake --build . --parallel
          cp webapp/* bin/

      - name: Upload Web Player
        uses: actions/upload-artifact@v4
        with:
          name: tic80-webapp
          path: build_web/bin/*
